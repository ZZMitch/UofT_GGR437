// Imports
var forest = 
    /* color: #0e900f */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([9.695573936656924, 44.496837184155126]),
            {
              "class": 0,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([9.6736871110954, 44.49832180112962]),
            {
              "class": 0,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([9.545464522536417, 44.5105915046179]),
            {
              "class": 0,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([9.286939595722309, 44.5110466339552]),
            {
              "class": 0,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Point([8.997918696995866, 44.57859529456824]),
            {
              "class": 0,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Point([9.907279202662544, 44.7173267156557]),
            {
              "class": 0,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Point([9.982950458460023, 44.67082843029203]),
            {
              "class": 0,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Point([10.153902224755234, 44.632068978652484]),
            {
              "class": 0,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([10.531428270784561, 44.54374445718314]),
            {
              "class": 0,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Point([10.548079424349014, 44.542092767386585]),
            {
              "class": 0,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Point([10.813020124135132, 44.02738746637606]),
            {
              "class": 0,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Point([10.70195521324646, 44.00529012248926]),
            {
              "class": 0,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Point([10.656121625599976, 43.98244343237244]),
            {
              "class": 0,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Point([10.767529859242554, 43.97836715243299]),
            {
              "class": 0,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Point([10.969565215272903, 44.07942618675087]),
            {
              "class": 0,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Point([10.825727406663276, 44.14203624468342]),
            {
              "class": 0,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Point([10.867526951951362, 44.139695647746315]),
            {
              "class": 0,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Point([10.108079999309568, 44.29203724798976]),
            {
              "class": 0,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Point([10.08507737479785, 44.27581571151742]),
            {
              "class": 0,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Point([10.13458267370257, 44.25266746634026]),
            {
              "class": 0,
              "system:index": "19"
            }),
        ee.Feature(
            ee.Geometry.Point([10.114412461910577, 44.24940904734803]),
            {
              "class": 0,
              "system:index": "20"
            }),
        ee.Feature(
            ee.Geometry.Point([10.158872758541436, 44.22087480296461]),
            {
              "class": 0,
              "system:index": "21"
            }),
        ee.Feature(
            ee.Geometry.Point([9.684453489663033, 44.31323799622055]),
            {
              "class": 0,
              "system:index": "22"
            }),
        ee.Feature(
            ee.Geometry.Point([9.401144809782283, 44.30924700887234]),
            {
              "class": 0,
              "system:index": "23"
            }),
        ee.Feature(
            ee.Geometry.Point([9.185356734461271, 44.31644593225463]),
            {
              "class": 0,
              "system:index": "24"
            })]),
    developed = 
    /* color: #ff0000 */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([10.399551050441417, 43.718413829822225]),
            {
              "class": 1,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([10.401267664210948, 43.71450557882414]),
            {
              "class": 1,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([10.915804133057625, 43.93307299140184]),
            {
              "class": 1,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([10.774537787910562, 43.88291957311495]),
            {
              "class": 1,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Point([10.034893068956453, 44.040889480668305]),
            {
              "class": 1,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Point([10.063217196153719, 44.046627197185686]),
            {
              "class": 1,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Point([10.074546847032625, 44.04058098554379]),
            {
              "class": 1,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Point([10.116632077036035, 44.02560684383405]),
            {
              "class": 1,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([9.865902463376587, 44.11353195151713]),
            {
              "class": 1,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Point([9.844702283322876, 44.12295954378073]),
            {
              "class": 1,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Point([9.813974896848267, 44.10810886412055]),
            {
              "class": 1,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Point([9.827192822873657, 44.100096574487765]),
            {
              "class": 1,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Point([9.330318967282837, 44.31402058296153]),
            {
              "class": 1,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Point([9.171788358443015, 45.45294165551311]),
            {
              "class": 1,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Point([9.176079892866843, 45.48087207604949]),
            {
              "class": 1,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Point([9.187237882368796, 45.47328889097045]),
            {
              "class": 1,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Point([9.203545713179343, 45.47690005875765]),
            {
              "class": 1,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Point([9.220196866743796, 45.436682670588226]),
            {
              "class": 1,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Point([9.254700803511374, 45.45125575634048]),
            {
              "class": 1,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Point([9.279313107096527, 45.58388901807382]),
            {
              "class": 1,
              "system:index": "19"
            }),
        ee.Feature(
            ee.Geometry.Point([9.32317258890805, 45.58424943588146]),
            {
              "class": 1,
              "system:index": "20"
            }),
        ee.Feature(
            ee.Geometry.Point([9.1679536277619, 45.627528869865635]),
            {
              "class": 1,
              "system:index": "21"
            }),
        ee.Feature(
            ee.Geometry.Point([9.204131880268012, 45.650783433035166]),
            {
              "class": 1,
              "system:index": "22"
            }),
        ee.Feature(
            ee.Geometry.Point([9.691200472551257, 45.05280268330943]),
            {
              "class": 1,
              "system:index": "23"
            }),
        ee.Feature(
            ee.Geometry.Point([10.792001415308986, 45.158007889385374]),
            {
              "class": 1,
              "system:index": "24"
            })]),
    water = 
    /* color: #1a11ff */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([8.858710565374736, 44.28319075846694]),
            {
              "class": 2,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([8.853217401312236, 44.078342642053755]),
            {
              "class": 2,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([9.094916620062236, 44.192672644146626]),
            {
              "class": 2,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([9.149848260687236, 44.01516927044871]),
            {
              "class": 2,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Point([9.402533807562236, 44.133564072703614]),
            {
              "class": 2,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Point([9.446479120062236, 43.98355732004592]),
            {
              "class": 2,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Point([9.671698846624736, 43.97960464201427]),
            {
              "class": 2,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Point([9.710150995062236, 43.85298000473638]),
            {
              "class": 2,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([9.935370721624736, 43.940063388210596]),
            {
              "class": 2,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Point([10.116645135687236, 43.876742648533096]),
            {
              "class": 2,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Point([10.177069940374736, 43.785601076213126]),
            {
              "class": 2,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Point([9.946357049749736, 43.79749700044004]),
            {
              "class": 2,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Point([8.913642205999736, 43.97960464201427]),
            {
              "class": 2,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Point([9.413520135687236, 43.888620418292156]),
            {
              "class": 2,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Point([9.226752557562236, 43.94797374417426]),
            {
              "class": 2,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Point([10.226508416937236, 43.69134144110975]),
            {
              "class": 2,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Point([9.984350491467907, 44.05132246554613]),
            {
              "class": 2,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Point([10.409699743991796, 44.98642866366897]),
            {
              "class": 2,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Point([10.481625860935155, 44.93517004079582]),
            {
              "class": 2,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Point([10.533810919528905, 44.912562837171514]),
            {
              "class": 2,
              "system:index": "19"
            }),
        ee.Feature(
            ee.Geometry.Point([10.60934192538828, 44.921260534338785]),
            {
              "class": 2,
              "system:index": "20"
            }),
        ee.Feature(
            ee.Geometry.Point([10.656576067578584, 44.955495503788846]),
            {
              "class": 2,
              "system:index": "21"
            }),
        ee.Feature(
            ee.Geometry.Point([10.689652366610533, 44.99229128218543]),
            {
              "class": 2,
              "system:index": "22"
            }),
        ee.Feature(
            ee.Geometry.Point([10.86403760157776, 45.06147563982671]),
            {
              "class": 2,
              "system:index": "23"
            }),
        ee.Feature(
            ee.Geometry.Point([11.060246555435182, 45.04571062683232]),
            {
              "class": 2,
              "system:index": "24"
            })]),
    herbaceous = 
    /* color: #d0741e */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([10.803686097880338, 43.70292872858358]),
            {
              "class": 3,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([10.84216287446524, 43.7076785417362]),
            {
              "class": 3,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Point([10.431261378927411, 43.650760621613216]),
            {
              "class": 3,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Point([10.448942500753583, 43.65225109205808]),
            {
              "class": 3,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Point([10.898775557161184, 44.61019924526715]),
            {
              "class": 3,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Point([10.838350752473684, 44.622052009206854]),
            {
              "class": 3,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Point([10.812773207307668, 44.64900706085619]),
            {
              "class": 3,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Point([10.927130816397396, 44.69007055259432]),
            {
              "class": 3,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Point([10.924727557120052, 44.683968344171035]),
            {
              "class": 3,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Point([10.995967028555599, 44.692145157017926]),
            {
              "class": 3,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Point([11.086432574209896, 44.696416167423166]),
            {
              "class": 3,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Point([10.70482762602825, 44.88853882313117]),
            {
              "class": 3,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Point([10.56921513823528, 44.86250650570732]),
            {
              "class": 3,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Point([10.832372029104421, 44.9175983786144]),
            {
              "class": 3,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Point([9.820386416095346, 44.943337262747704]),
            {
              "class": 3,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Point([9.784852511066049, 44.94455227895142]),
            {
              "class": 3,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Point([9.777986055987924, 44.951841836152205]),
            {
              "class": 3,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Point([9.516197823173993, 45.05170231259991]),
            {
              "class": 3,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Point([9.198879502195098, 45.237457496752015]),
            {
              "class": 3,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Point([9.083380824479143, 45.38340066916999]),
            {
              "class": 3,
              "system:index": "19"
            }),
        ee.Feature(
            ee.Geometry.Point([9.052825099381486, 45.34046217942483]),
            {
              "class": 3,
              "system:index": "20"
            }),
        ee.Feature(
            ee.Geometry.Point([9.085784083756486, 45.314152297248015]),
            {
              "class": 3,
              "system:index": "21"
            }),
        ee.Feature(
            ee.Geometry.Point([9.018836146744768, 45.26330825826861]),
            {
              "class": 3,
              "system:index": "22"
            }),
        ee.Feature(
            ee.Geometry.Point([9.084582454117815, 45.24663212300294]),
            {
              "class": 3,
              "system:index": "23"
            }),
        ee.Feature(
            ee.Geometry.Point([9.131274348649065, 45.21749756341439]),
            {
              "class": 3,
              "system:index": "24"
            })]);

//  GEE Textbook F2.1 Code

// Create an Earth Engine Point object over Milan.
var pt = ee.Geometry.Point(9.453,45.424);

// Filter the Landsat 8 collection and select the least cloudy image.
var landsat = ee.ImageCollection('LANDSAT/LC08/C02/T1_L2')
                     .filterDate('2019-01-01', '2020-01-01')
                     .filterBounds(pt)
                     .sort('CLOUD_COVER').first();

// Center the map in that image.
Map.centerObject(landsat,8);

// Add Landsat image to the map.
Map.addLayer(landsat, {bands: ['SR_B4', 'SR_B3', 'SR_B2'], min: 7000,max: 12000}, 'Landsat 8 image');

// Merge training feature collections.
var trainingFeatures = forest.merge(developed).merge(water).merge(herbaceous);
print(trainingFeatures, "Training points");

// Define prediction bands.
var predictionBands = ['SR_B1', 'SR_B2', 'SR_B3', 'SR_B4', 'SR_B5', 'SR_B6', 'SR_B7', 'ST_B10'];

// Sample training points.
var classifierTraining = landsat.select(predictionBands)
    .sampleRegions({
      collection: trainingFeatures, 
      properties: ['class'], 
      scale: 30
    });
print(classifierTraining, "Spectral values at training points");

//////////////// CART Classifier ///////////////////

// Train CART Classifier.
var classifier = ee.Classifier.smileCart().train({
  features: classifierTraining, 
  classProperty: 'class', 
  inputProperties: predictionBands
});
print(classifier.explain(), "CART classified"); 

// Classify Landsat image.
var classified = landsat.select(predictionBands).classify(classifier);

// Define classification image visualization parameters.
var classificationVis = {
  min: 0, max: 3, palette: ['589400', 'ff0000', '1a11ff', 'd0741e']
};

// Add classified image to the map.
Map.addLayer(classified, classificationVis, 'CART classified');

/////////////// Random Forest Classifier /////////////////////

// Train RF classifier.
var RFclassifier = ee.Classifier.smileRandomForest(500).train({
  features:classifierTraining, 
  classProperty: 'class',
  inputProperties:predictionBands
});

// Classify Landsat image.
var RFclassified = landsat.select(predictionBands).classify(RFclassifier);

// Add classified image to the map.
Map.addLayer(RFclassified, classificationVis, 'RF classified');

//////////////// Unsupervised classification ////////////////

// Make the training dataset.
var training = landsat.sample({
  region: landsat.geometry(),
  scale: 30,
  numPixels: 1000,
  tileScale: 8
});

// Instantiate the clusterer and train it.
var clusterer = ee.Clusterer.wekaKMeans(4).train(training);

// Cluster the input using the trained clusterer.
var Kclassified = landsat.cluster(clusterer);

// Display the clusters with random colors.
//Map.addLayer(Kclassified.randomVisualizer(), {}, 'K-means classified - random colors');

// Display the clusters with same palette as supervised classification
// herbaceous is 0, water is 1, forest is 2, developed is 3
Map.addLayer(Kclassified, 
            {min: 0, max: 3, palette: ['d0741e','1a11ff','589400', 'ff0000']}, 
            'K-means classified');